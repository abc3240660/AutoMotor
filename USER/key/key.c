#include "key.h"

/*********************************************************************************
*********************???? STM32F407?????(???)*************************
**********************************************************************************
* ????: key.c                                                                *
* ????:??????                                                         *
* ????:2015.10.03                                                           *
* ?    ?:V1.0                                                                 *
* ?    ?:Clever                                                               *
* ?    ?:?????,???????????                                   * 
**********************************************************************************?
*********************************************************************************/

/**
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~??????~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
???????,????????,????????
		1?????????????,????? keydown_data ????
		2?????????????,????? keyup_data   ????
		3???????,????????key_time>???,??????????????
		   ????,???????,???????,?????
		4????????????????????,???????key_tem?key_time
		   ????,???????(key_tem)????(key_time)????????
????????
    1???:????(????)??????????
		2???:?????????????????????????
		3?void key_scan(u8 mode) ? mode   0:??   1:??
??????????;
    1?????????keyup_data?,?????????,???????????,?
		   ??????,?????keyup_data?,??mode?????0
		2?????keydown_data?key_time??????,??mode????1,???
		3?????keyup_data?key_time??????,????????????,????
		   ??,? key_time=0; ?? key_tem=0;???????????????,????
			 ?????????????????????,????????,???????
			 ?key_time??,key_time??????????????????????????
			 ????key_time?????????????????????
**/

u8  keydown_data=0x00;    //??????????
u8  keyup_data=0x00;      //???????
u16  key_time=0x00;       //???????????,?????????????????????????

u8  key_tem=0x00;         //?????????????????
u8  key_bak=0x00;         //??????????

//??IO??????
void KEY_Init(void)
{
	GPIO_InitTypeDef  GPIO_InitStructure;

  RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOF, ENABLE);    //??GPIOF??
 
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6|GPIO_Pin_7|GPIO_Pin_8|GPIO_Pin_9|GPIO_Pin_12; //KEY0 KEY1 KEY2 KEY3????
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN;             //??????
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;       //100M
  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;             //??
  GPIO_Init(GPIOF, &GPIO_InitStructure);                   //???GPIOF6,7,8,9
} 
/****************************************************************************
* ?    ?: void key_scan(u8 mode)
* ?    ?:??????
* ????:mode:0:?? 
                  1: ??
* ????:?
* ?    ?:?????,KEY0>KEY1>KEY2>KEY3?
****************************************************************************/
void key_scan(u8 mode)
{	   
	 keyup_data=0;         //???????????
	
	if(KEY0==0||KEY1==0||KEY2==0||KEY3==0)   //?????
	{
		if(KEY0==0)      key_tem=1;
		else if(KEY1==0) key_tem=2;
		else if(KEY2==0) key_tem=3;
		else if(KEY3==0) key_tem=4;
		
		  if (key_tem == key_bak)      //?????????????,?else?????????,????????
			  {
				   key_time++;             //?????????????,????1
					 keydown_data=key_tem;   //?????keydown_data
					
					 if( (mode==0)&&(key_time>1) )//key_time>1?????,?????,??mode?1????
					    keydown_data=0;
       	}
	    else                             //???      
	      {
		       key_time=0;
		       key_bak=key_tem;
	      }
		
	}
	else       //???
		{
	     if(key_time>2)            //????????????
	        {
		        keyup_data=key_tem;  //?????????keydown_data            						
	       	}
				key_bak=0;               //???,???????????????????????,?????????
	      key_time=0;
				keydown_data=0;		
	  }    
}
